name: Build Logger Library for Cross-platform make by Nhen

on:
  push:
    branches:
      - 'feature/*'
      - 'bugfix/*'
      - 'hotfix/*'
  pull_request:
    branches:
      - master
  schedule:
    - cron: '0 2 * * *'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y build-essential cmake lcov clang-tidy

    # --- Configure CMake with coverage enabled ---
    - name: Configure CMake
      run: |
        cmake -S . -B build \
              -DENABLE_LINT=ON \
              -DENABLE_COVERAGE=ON \
              -DCMAKE_BUILD_TYPE=Debug \
              -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Check linter
      run: cmake --build build --target lint

    - name: Build project
      run: cmake --build build -- -j$(nproc)

    # --- Run all test binaries in build/test ---
    - name: Run all tests
      run: |
        find build/test -maxdepth 1 -type f -executable -print0 | while IFS= read -r -d '' testfile; do
          echo "Running $testfile"
          "$testfile"
        done

    # --- Collect Coverage ---
    - name: Capture Coverage
      run: |
        lcov --capture --directory build --output-file coverage.info

        # Remove unwanted coverage paths
        lcov --remove coverage.info \
            '/usr/*' \
            '*/third-party/googletest/*' \
            '*/build/test/*' \
            --output-file coverage.info

        # Show coverage summary in logs
        lcov --list coverage.info

    # --- Generate HTML report ---
    - name: Generate Coverage Report
      run: |
        genhtml coverage.info --output-directory coverage_report

    # --- Upload as GitHub artifact ---
    # - name: Upload Coverage Report
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: coverage-report
    #     path: coverage_report/
